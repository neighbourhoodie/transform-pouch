!function(n){"function"==typeof define&&define.amd?define(n):n()}(function(){"use strict";const o=require("pouchdb-wrappers");function t(n){return"_"!==n[0]}function e(n){return"string"==typeof n._id&&/^_local/.test(n._id)||n._deleted&&0===Object.keys(n).filter(t).length}exports.transform=exports.filter=function(t){const r=function(n){return!e(n)&&t.incoming?t.incoming(n):n},i=function(n){return!e(n)&&t.outgoing?t.outgoing(n):n},n={};"http"===this.type()&&(n.put=function(t,o){try{return o.doc=r(o.doc),Promise.resolve(o.doc).then(function(n){return o.doc=n,t()})}catch(n){return Promise.reject(n)}},n.query=function(n){const r={};return n().then(function(o){return Promise.all(o.rows.map(function(n){return n.doc?i(n.doc):r})).then(function(n){return n.forEach(function(n,t){n!==r&&(o.rows[t].doc=n)}),o})})}),n.get=function(n){return n().then(function(o){if(Array.isArray(o)){const r={};return Promise.all(o.map(function(n){return n.ok?i(n.ok):r})).then(function(n){return n.forEach(function(n,t){n!==r&&(o[t].ok=n)}),o})}return i(o)})},n.bulkDocs=function(t,o){for(let n=0;n<o.docs.length;n++)o.docs[n]=r(o.docs[n]);return Promise.all(o.docs).then(function(n){return o.docs=n,t()})},n.allDocs=function(n){return n().then(function(o){const r={};return Promise.all(o.rows.map(function(n){return n.doc?i(n.doc):r})).then(function(n){return n.forEach(function(n,t){n!==r&&(o.rows[t].doc=n)}),o})})},n.bulkGet=function(n){return n().then(function(n){const t={};return Promise.all(n.results.map(function(n){return n.id&&n.docs&&Array.isArray(n.docs)?{docs:n.docs.map(function(n){return n.ok?{ok:i(n.ok)}:n}),id:n.id}:t})).then(function(n){return{results:n}})})},n.changes=function(n){function o(t){return t.doc?Promise.resolve(i(t.doc)).then(function(n){return t.doc=n,t}):Promise.resolve(t)}function r(t){return t.results?Promise.all(t.results.map(o)).then(function(n){return t.results=n,t}):Promise.resolve(t)}const e=n(),c=e.on;e.on=function(n,t){return"change"===n?c.apply(e,[n,function(n){o(n).then(function(n){process.nextTick(function(){t(n)})})}]):"complete"===n?c.apply(e,[n,function(n){r(n).then(function(n){process.nextTick(function(){t(n)})})}]):c.apply(e,[n,t])};const u=e.then;return e.then=function(t,o){return u.apply(e,[function(n){return r(n).then(t,o)},o])},e},o.installWrapperMethods(this,n)},"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(exports)});
